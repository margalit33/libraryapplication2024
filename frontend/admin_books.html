<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Library</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
        font-family: Arial, sans-serif;
      }
      .form-container {
        background-color: #fff;
        border-radius: 5px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }
      h1 {
        color: #343a40;
      }
      .form-group label {
        color: #495057;
      }
      .form-group input[type="text"],
      .form-group input[type="password"],
      .form-group input[type="number"] {
        width: 100%;
        max-width: 300px;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        margin-bottom: 5px;
      }
      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
      }
      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">Library Management System</h1>

      <!-- Admin Registration Form -->
      <div class="form-container">
        <h2>Admin Registration</h2>
        <form id="adminRegistrationForm">
          <div class="form-group">
            <label for="adminRegisterUsername">Username:</label>
            <input
              type="text"
              id="adminRegisterUsername"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="adminRegisterPassword">Password:</label>
            <input
              type="password"
              id="adminRegisterPassword"
              class="form-control"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Register</button>
        </form>
      </div>

      <!-- Admin Login Form -->
      <div class="form-container">
        <h2>Admin Login</h2>
        <form id="adminLoginForm">
          <div class="form-group">
            <label for="adminLoginUsername">Username:</label>
            <input
              type="text"
              id="adminLoginUsername"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="adminLoginPassword">Password:</label>
            <input
              type="password"
              id="adminLoginPassword"
              class="form-control"
              required
            />
          </div>
          <button type="submit" id="adminLoginButton" class="btn btn-primary">
            Login
          </button>
        </form>
      </div>

      <!-- Book Management -->
      <div class="form-container hidden" id="bookManagement">
        <h2>Book Management</h2>

        <!-- Create Book Form -->
        <form id="createBookForm">
          <h3>Create New Book</h3>
          <div class="form-group">
            <label for="bookName">Name:</label>
            <input type="text" id="bookName" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="bookAuthor">Author:</label>
            <input type="text" id="bookAuthor" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="bookYear_published">Year_published:</label>
            <input
              type="number"
              id="bookYear_published"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="bookBook_type">Book_type:</label>
            <input
              type="number"
              id="bookBook_Type"
              class="form-control"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Create</button>
        </form>

        <!-- Update Book Form -->
        <form id="updateBookForm">
          <h3>Update Book</h3>
          <div class="form-group">
            <label for="updateBookId">Book ID:</label>
            <input
              type="number"
              id="updateBookId"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="updateBookName">Name:</label>
            <input
              type="text"
              id="updateBookName"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="updateBookAuthor">Author:</label>
            <input
              type="text"
              id="updateBookAuthor"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="updateBookYear_published">Year_published:</label>
            <input
              type="number"
              id="updateBookYear_published"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="updateBookBook_Type">Book_Type:</label>
            <input
              type="number"
              id="updateBookBook_Type"
              class="form-control"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">Update</button>
        </form>

        <!-- Delete Book Form -->
        <form id="deleteBookForm">
          <h3>Delete Book</h3>
          <div class="form-group">
            <label for="deleteBookId">Book ID:</label>
            <input
              type="number"
              id="deleteBookId"
              class="form-control"
              required
            />
          </div>
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
      <ul id="bookList"></ul>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
      // Function to register a new admin user
      const registerAdmin = async (username, password, is_admin) => {
        try {
          const response = await axios.post("http://127.0.0.1:5000/register", {
            username: username,
            password: password,
            is_admin: is_admin,
          });
          alert(response.data.message);
        } catch (error) {
          alert("Error registering admin user: " + error.response.data.message);
        }
      };

      // Add event listeners for admin registration forms
      document
        .getElementById("adminRegistrationForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const username = document.getElementById(
            "adminRegisterUsername"
          ).value;
          const password = document.getElementById(
            "adminRegisterPassword"
          ).value;
          registerAdmin(username, password, true);
        });

      // Function to check if the admin is authenticated
      const isAuthenticated = () => {
        const token = localStorage.getItem("token");
        return token !== null;
      };

      // Function to get the JWT token from localStorage
      const getToken = () => {
        return localStorage.getItem("token");
      };

      // Function to log in as an admin
      const loginAdmin = async (username, password) => {
        try {
          const response = await axios.post("http://127.0.0.1:5000/login", {
            username: username,
            password: password,
          });
          const token = response.data.access_token;
          localStorage.setItem("token", token);
          alert("Admin login successful");

          // Show Book management section
          document.getElementById("adminLoginForm").classList.add("hidden");
          document.getElementById("bookManagement").classList.remove("hidden");

          // Event listener for creating a book
          document
            .getElementById("createBookForm")
            .addEventListener("submit", async (event) => {
              event.preventDefault(); // Prevent default form submission
              const name = document.getElementById("bookName").value;
              const author = document.getElementById("bookAuthor").value;
              const year_published =
                document.getElementById("bookYear_published").value;
              const book_type = document.getElementById("bookBook_Type").value;
              await createBook(name, author, year_published, book_type);
            });

          // Event listener for updating a book
          document
            .getElementById("updateBookForm")
            .addEventListener("submit", async (event) => {
              event.preventDefault(); // Prevent default form submission
              const bookId = document.getElementById("updateBookId").value;
              const name = document.getElementById("updateBookName").value;
              const author = document.getElementById("updateBookAuthor").value;
              const year_published = document.getElementById(
                "updateBookYear_published"
              ).value;
              const book_type = document.getElementById(
                "updateBookBook_Type"
              ).value;

              await updateBook(bookId, name, author, year_published, book_type);
            });
        } catch (error) {
          alert("Error logging in as admin: " + error.response.data.message);
        }
      };

      // Function to create a new book
      const createBook = async (name, author, year_published, book_type) => {
        try {
          if (isAuthenticated()) {
            const token = getToken();
            const config = {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            };
            const response = await axios.post(
              "http://127.0.0.1:5000/new_book",
              {
                name: name,
                author: author,
                year_published: year_published,
                book_type: book_type,
              },
              config // Include token in request headers
            );
            alert(response.data);
            // Refresh books list after adding
            getBooks();
          } else {
            console.error("User is not authenticated");
            // Redirect to login page or display a message indicating that the user needs to log in
          }
        } catch (error) {
          alert("Error adding book: " + error.response.data);
        }
      };

      // Code to fetch books from the backend
      const getBooks = async () => {
        try {
          const response = await axios.get("http://127.0.0.1:5000/books");
          const books = response.data;
          const bookList = document.getElementById("bookList");
          bookList.innerHTML = "";
          books.forEach((book) => {
            const bookInfo = `ID: ${book.id}, 
                            Name: ${book.name}, 
                            Author: ${book.author}, 
                            Year_published: ${book.year_published}, 
                            Book_Type: ${book.book_type}`;
            const listItem = document.createElement("li");
            listItem.textContent = bookInfo;
            bookList.appendChild(listItem);
          });
        } catch (error) {
          console.error("Error fetching books: " + error);
        }
      };
      // Function to update a book
      const updateBook = async (
        bookId,
        name,
        author,
        year_published,
        book_type
      ) => {
        try {
          if (isAuthenticated()) {
            const token = getToken();
            const config = {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            };
            const response = await axios.put(
              `http://127.0.0.1:5000/upd_book/${bookId}`,
              {
                name: name,
                author: author,
                year_published: year_published,
                book_type: book_type,
              },
              config
            );

            if (response && response.data && response.data.message) {
              alert(response.data.message); // Display the message from the response
            } else {
              alert("Book updated successfully");
            }

            // Refresh books list after updating
            getBooks();
          } else {
            console.error("User is not authenticated");
            // Redirect to login page or display a message indicating that the user needs to log in
          }
        } catch (error) {
          // Handle error response
          if (
            error.response &&
            error.response.data &&
            error.response.data.message
          ) {
            alert("Error updating book: " + error.response.data.message);
          } else {
            alert("Error updating book: " + error.message);
          }
        }
      };

      document
        .getElementById("deleteBookForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent the default form submission behavior

          const bookId = document.getElementById("deleteBookId").value;

          try {
            if (isAuthenticated()) {
              const token = getToken();
              const config = {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              };
              const response = await axios.delete(
                `http://127.0.0.1:5000/del_book/${bookId}`,
                config
              );
              const responseMessage =
                response.data && response.data.message
                  ? response.data.message
                  : "Book deleted successfully";
              alert(responseMessage); // Display the message from the response
              // Refresh books list after deleting
              getBooks();
            } else {
              console.error("User is not authenticated");
              // Redirect to login page or display a message indicating that the user needs to log in
            }
          } catch (error) {
            // Handle error response
            if (
              error.response &&
              error.response.data &&
              error.response.data.message
            ) {
              alert("Error deleting book: " + error.response.data.message);
            } else {
              alert("Error deleting book: " + error.message);
            }
          }
        });

      // Add event listener to fetch books when DOM content is loaded
      document.addEventListener("DOMContentLoaded", function () {
        getBooks(); // Call getBooks function when DOM content is loaded
      });

      // Event listener for admin login form submission
      document
        .getElementById("adminLoginForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault(); // Prevent default form submission
          const username = document.getElementById("adminLoginUsername").value;
          const password = document.getElementById("adminLoginPassword").value;
          await loginAdmin(username, password);
        });
    </script>
  </body>
</html>
